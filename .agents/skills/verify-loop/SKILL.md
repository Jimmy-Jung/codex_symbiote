---
name: verify-loop
description: 자율 작업 루프에서 자기 수정 동작의 가이드라인. 4-Level Completion Criteria, 재시도 전략, 루프 탈출 조건을 정의. Use when running autonomous execution loops (Ralph Loop, Autopilot) that need structured verify-fix cycles.
source: origin
---

# 검증 루프 (Verify Loop)

자율 작업 루프의 자기 수정 동작 가이드라인.

## 자기 수정 루프 흐름

```
Execute (구현)
    ↓
Verify (검증)
    ↓
[이슈 있음?] ─Yes→ Analyze (원인 분석) → Fix (수정) → Execute (재시도)
    │
    No
    ↓
Complete (완료)
```

각 반복에서 이전 실패 원인을 반영하고, 동일 접근은 최대 2회까지만 사용한다.

## 4단계 완료 기준

### Level 1 (Minimal)
- 코드 변경 완료
- 린트 오류 0개 (프로젝트 표준 도구 기준)
- 기본 문법/타입/컴파일 검사 통과
- 최소 실행 검증(스모크) 통과
- 적용: 단순 수정, 짧은 작업

### Level 2 (Standard)
- Level 1 충족
- 기능 검증 완료 (동작 확인)
- 코드 리뷰 체크리스트 충족 (Reviewer 기준)
- 논리적 정확성 확인
- 적용: 일반 작업, 버그 수정

### Level 3 (Thorough)
- Level 2 충족
- 모든 테스트 통과
- 엣지 케이스 처리
- 문서화 갱신
- QA 검증 기준 충족
- 적용: 기능 구현, 리팩토링

### Level 4 (Production)
- Level 3 충족
- 보안 검토
- 성능 회귀 없음 확인
- 통합/E2E 검증
- 적용: 릴리즈, 배포 전

## 재시도 전략

### 원인 분석 필수
검증 실패 시 즉시 수정하지 않고, 반드시 원인을 먼저 분석한다:
- 무엇이 실패했는가 (증상)
- 왜 실패했는가 (근본 원인)
- 이전 시도에서 무엇이 잘못되었는가
- 다음 시도에서 무엇을 다르게 할 것인가

### 동일 접근 금지
- 동일 접근은 최대 2회까지만 허용
- 같은 에러가 2회 연속 반복되면 근본적으로 다른 접근법 시도
- 접근 변경 예: 직접 구현 실패 → 기존 유사 코드 참조

### 오류 유형별 최대 재시도
- 컴파일 에러: 유사 패턴 2회까지
- 동일 에러 3회 연속: 접근 전환
- 총 5회 재시도: 사용자 에스컬레이션

### 유사 에러 시
- 외부 요인(네트워크/CI) 의심 시 지수적 백오프(30s→60s→120s) 적용
- 같은 패턴 반복 시 접근 전환

## 루프 탈출 조건

### 정상 종료
- 선택한 Level의 모든 기준 충족

### 강제 종료 (에스컬레이션)
- 동일 오류 3회 연속 → 사용자 에스컬레이션
- 총 5회 재시도 → 사용자 에스컬레이션
- 토큰 예산 초과 → note 스킬로 상태 저장
- 파괴적 변경 필요 시 사용자 확인
- 요구사항 모호 시 사용자 확인

### 강제 종료 보고 형식

```
[Verify Loop 강제 종료]

- 반복 횟수: N/M
- 탈출 사유: [사유]
- 최종 상태: [달성한 것 / 미달성한 것]
- 발견된 이슈: [목록]
- 권장 조치: [사용자에게 제안]
```

## 실패 패턴 분류 및 대응

| 패턴 | 인식 기준 | 가능 원인 | 대응 전략 |
|------|----------|----------|----------|
| 컴파일 에러 | 빌드 즉시 실패 | import 누락, 문법 오류 | import/문법 수정 후 재빌드 |
| 타입 에러 | 타입/시그니처 불일치 | 타입 정의 오해 | 실제 타입 정의 확인 후 수정 |
| 로직 에러 | 테스트/수동 검증 실패 | 요구사항 해석 오류 | 요구사항 재분석 후 로직 수정 |
| 테스트 실패 | 기대값 불일치 | 테스트 또는 구현 불일치 | 기대값/구현 중 기준 재확인 |
| 빌드 설정 에러 | 환경별 빌드 실패 | 설정/스크립트 누락 | 프로젝트 설정 및 스크립트 점검 |
| 심볼 미존재 | 참조 에러 반복 | 잘못된 심볼 사용 | Grep으로 실제 심볼 검색 후 교체 |
| 패턴 불일치 | 아키텍처 규칙 위반 | 기존 패턴 미준수 | 룰/기존 구현 참조 후 구조 정렬 |
| 의존성 누락 | import/DI 실패 | 의존성 선언 누락 | 의존성 그래프 분석 후 추가 |
| 순환 참조 | 구조/메모리 경고 | 모듈 결합 과다 | 참조 방향 재설계 |

## 반복 간 컨텍스트 전달

### 유지할 것
- 이전 시도의 실패 원인
- 발견된 코드베이스 정보 (심볼, 패턴, 관계)
- 적용한 수정 사항
- 남은 이슈 목록

### 버릴 것
- 실패한 접근 방식의 상세
- 검증된 잘못된 가정

## 성능 원칙

- 최소 수정: 수정 사이클에서는 최소한의 변경만 수행
- 과도한 설계 금지: 수정 중에는 오버엔지니어링 지양
- 병렬 실행: 독립 작업은 병렬 수행
- Fail Fast: 조기 실패 시 불필요한 후속 단계 건너뜀
- 검증 범위: Level 1 통과 후 상위 Level로 확대
